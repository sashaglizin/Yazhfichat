<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Изолированные чат-комнаты</title>
    <style>
        :root {
            --bg: #F5F1E8;
            --surface: #FFFCF5;
            --primary: #B8A690;
            --text: #4A453D;
            --border: #D3CEC4;
            --error: #C4A5A5;
            --online: #A5B8A5;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .screen {
            text-align: center;
        }
        input, button {
            padding: 12px;
            margin: 5px;
            border-radius: 6px;
            font-size: 16px;
        }
        input {
            border: 1px solid var(--border);
            width: 250px;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            min-width: 150px;
        }
        #chatScreen {
            display: none;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            background: var(--surface);
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            background: var(--bg);
            border-radius: 4px;
        }
        .message .author {
            font-weight: bold;
            color: #5a4a3a;
        }
        .error {
            color: var(--error);
            margin-top: 10px;
        }
        .online-counter {
            background: var(--online);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        .you {
            background: #e8e0d0;
        }
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .room-card {
            background: var(--surface);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .room-card:hover {
            transform: translateY(-3px);
        }
        .room-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        .room-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .room-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .back-btn {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Экран ввода имени -->
        <div id="nameScreen" class="screen">
            <h2>Введите ваше имя</h2>
            <input type="text" id="userName" placeholder="Как вас называть?">
            <button onclick="setUserName()">Продолжить</button>
            <p id="nameError" class="error"></p>
        </div>

        <!-- Экран выбора комнаты -->
        <div id="connectScreen" class="screen" style="display:none">
            <h2>Выберите комнату</h2>
            <input type="text" id="roomIdInput" placeholder="Или введите ID комнаты">
            <button onclick="connectToCustomRoom()">Подключиться</button>
            <button onclick="createNewRoom()" class="back-btn">Создать свою</button>
            
            <div class="rooms-grid" id="publicRooms">
                <!-- Общие комнаты будут здесь -->
            </div>
        </div>

        <!-- Экран чата -->
        <div id="chatScreen" class="screen">
            <h3>Комната: <span id="currentRoomId"></span></h3>
            <div class="online-counter">Онлайн: <span id="onlineCount">1</span></div>
            <div id="messages"></div>
            <textarea id="messageInput" placeholder="Ваше сообщение..." rows="3"></textarea>
            <button onclick="sendMessage()">Отправить</button>
            <button onclick="backToRooms()" class="back-btn">← Назад к комнатам</button>
        </div>
    </div>

    <!-- Firebase + наш код -->
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-database-compat.js"></script>
    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAptJ1ODkI8cdQWSHE50Pab7sbh0azmMv4",
            authDomain: "chan-3ad7d.firebaseapp.com",
            databaseURL: "https://chanik-default-rtdb.firebaseio.com",
            projectId: "chan-3ad7d",
            storageBucket: "chan-3ad7d.firebasestorage.app",
            messagingSenderId: "789733189882",
            appId: "1:789733189882:web:d81d9af1d4e1b89d66c143"
        };

        // Инициализация Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Общие комнаты (каждая имеет УНИКАЛЬНЫЙ ID)
        const PUBLIC_ROOMS = [
            {
                id: "main_chat_room",
                title: "Общение и знакомства",
                desc: "Общайтесь на любые темы"
            },
            {
                id: "anime_room",
                title: "Аниме",
                desc: "Обсуждение аниме и манги"
            },
            {
                id: "games_room",
                title: "Игры",
                desc: "Видеоигры и настолки"
            },
            {
                id: "business_room",
                title: "Бизнес",
                desc: "Стартапы и предпринимательство"
            },
            {
                id: "sport_room",
                title: "Спорт",
                desc: "Футбол, хоккей и другие виды"
            },
            {
                id: "fetish_room",
                title: "Фетиши",
                desc: "Обсуждение необычных увлечений"
            },
            {
                id: "adult_room",
                title: "18+ Интим",
                desc: "Только для взрослых"
            },
            {
                id: "creative_room",
                title: "Творчество",
                desc: "Рисование, музыка, писательство"
            },
            {
                id: "school2_room",
                title: "Лицей №2",
                desc: "Для учеников и преподавателей"
            },
            {
                id: "education_room",
                title: "Образование",
                desc: "Учёба и саморазвитие"
            }
        ];

        // Глобальные переменные
        let currentUser = {
            name: "",
            id: Math.random().toString(36).substr(2, 8)
        };
        let currentRoomId = "";
        let userRef;
        let messagesRef; // Ссылка на сообщения текущей комнаты

        // Заполняем список общих комнат
        function renderPublicRooms() {
            const container = document.getElementById('publicRooms');
            container.innerHTML = '';
            
            PUBLIC_ROOMS.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-card';
                roomElement.innerHTML = `
                    <div class="room-title">${room.title}</div>
                    <div class="room-desc">${room.desc}</div>
                    <div class="room-footer">
                        <div class="online-counter" id="room-${room.id}-count">0 онлайн</div>
                        <button style="padding: 5px 10px;">Войти</button>
                    </div>
                `;
                
                roomElement.querySelector('button').addEventListener('click', () => {
                    currentRoomId = room.id;
                    startChat();
                });
                
                // Загружаем количество онлайн для каждой комнаты
                db.ref('presence/' + room.id + '/users').on('value', (snap) => {
                    const count = snap.val() ? Object.keys(snap.val()).length : 0;
                    document.getElementById(`room-${room.id}-count`).textContent = `${count} онлайн`;
                });
                
                container.appendChild(roomElement);
            });
        }

        // Установка имени пользователя
        function setUserName() {
            const name = document.getElementById('userName').value.trim();
            if (!name) {
                document.getElementById('nameError').textContent = "Введите имя!";
                return;
            }
            
            currentUser.name = name;
            document.getElementById('nameScreen').style.display = 'none';
            document.getElementById('connectScreen').style.display = 'block';
            renderPublicRooms();
        }

        // Подключение к произвольной комнате
        function connectToCustomRoom() {
            currentRoomId = document.getElementById('roomIdInput').value.trim();
            if (!currentRoomId) return;
            
            startChat();
        }

        // Создание новой комнаты
        function createNewRoom() {
            currentRoomId = generateRoomId();
            document.getElementById('roomIdInput').value = currentRoomId;
            startChat();
        }

        // Генерация ID комнаты
        function generateRoomId() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // Система присутствия
        function setupPresence() {
            // Удаляем старую запись если была
            if (userRef) userRef.remove();
            
            // Создаем новую запись
            userRef = db.ref('presence/' + currentRoomId + '/users/' + currentUser.id);
            
            userRef.set({
                name: currentUser.name,
                online: true,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });

            userRef.onDisconnect().remove();

            // Обновляем счетчик онлайн
            db.ref('presence/' + currentRoomId + '/users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                document.getElementById('onlineCount').textContent = Object.keys(users).length;
            });
        }

        // Запуск чата
        function startChat() {
            document.getElementById('connectScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'block';
            
            // Находим название комнаты
            const roomInfo = PUBLIC_ROOMS.find(r => r.id === currentRoomId);
            const roomTitle = roomInfo ? roomInfo.title : currentRoomId;
            document.getElementById('currentRoomId').textContent = roomTitle;

            // Очищаем предыдущие сообщения
            document.getElementById('messages').innerHTML = '';
            
            // Отключаем старый слушатель если был
            if (messagesRef) messagesRef.off();
            
            setupPresence();

            // Подключаемся к сообщениям КОНКРЕТНОЙ комнаты
            messagesRef = db.ref('rooms/' + currentRoomId + '/messages');
            
            messagesRef.on('child_added', function(snapshot) {
                const msg = snapshot.val();
                addMessageToChat(msg);
            });
        }

        // Отправка сообщения
        function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) return;

            messagesRef.push({
                text: message,
                timestamp: Date.now(),
                user: currentUser.name,
                userId: currentUser.id
            });

            document.getElementById('messageInput').value = '';
        }

        // Добавление сообщения в чат
        function addMessageToChat(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgElement = document.createElement('div');
            msgElement.className = 'message';
            
            if (msg.userId === currentUser.id) {
                msgElement.innerHTML = `<span class="author">Вы:</span> ${msg.text}`;
                msgElement.classList.add('you');
            } else {
                msgElement.innerHTML = `<span class="author">${msg.user}:</span> ${msg.text}`;
            }
            
            messagesDiv.appendChild(msgElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Возврат к списку комнат
        function backToRooms() {
            if (userRef) userRef.remove();
            if (messagesRef) messagesRef.off();
            
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('connectScreen').style.display = 'block';
            document.getElementById('messageInput').value = '';
        }

        // Автоподключение если в URL есть room ID
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('room')) {
            document.getElementById('nameScreen').style.display = 'none';
            document.getElementById('connectScreen').style.display = 'block';
            document.getElementById('roomIdInput').value = urlParams.get('room');
            renderPublicRooms();
        }
    </script>
</body>
</html>