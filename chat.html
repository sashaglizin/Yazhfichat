<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç—ã - –§–∏—á–∞—Ç</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }

        body {
            background-color: #FFFFEE;
            color: #000;
            line-height: 1.4;
            font-size: 14px;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background-color: #FF6600;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #000;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #000;
            font-weight: bold;
            font-size: 1.5rem;
            flex: 1;
            text-align: center;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .chats-screen {
            background-color: #F6E6CC;
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .chat-screen {
            background-color: #F6E6CC;
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            background-color: #FFFFEE;
            border: 1px solid #000;
            padding: 10px;
            font-size: 16px;
            border-radius: 4px;
        }

        .chats-list {
            max-height: 60vh;
            overflow-y: auto;
            background-color: #FFFFEE;
            border: 1px solid #000;
            border-radius: 4px;
        }

        .chat-item {
            padding: 12px;
            border-bottom: 1px solid #EEE;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chat-item:hover {
            background-color: #F6E6CC;
        }

        .chat-item:last-child {
            border-bottom: none;
        }

        .chat-item.unread {
            background-color: #FFF0E0;
            border-left: 4px solid #FF6600;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #FF6600;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: bold;
            color: #117743;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-last-message {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            text-align: right;
            min-width: 60px;
        }

        .chat-time {
            font-size: 12px;
            color: #707070;
            margin-bottom: 4px;
        }

        .chat-unread {
            background-color: #FF6600;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-left: auto;
        }

        .chat-container {
            max-height: 60vh;
            overflow-y: auto;
            background-color: #FFFFEE;
            border: 1px solid #000;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #CCC;
        }

        .message-header {
            color: #117743;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .message-time {
            color: #707070;
            font-size: 12px;
        }

        .message-content {
            color: #000;
            word-break: break-word;
        }

        .message-content img {
            max-width: 100%;
            margin-top: 5px;
            border: 1px solid #CCC;
            border-radius: 4px;
            max-height: 300px;
            object-fit: contain;
        }

        .message-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-direction: column;
        }

        .message-input {
            flex: 1;
            background-color: #FFFFEE;
            border: 1px solid #000;
            padding: 10px;
            font-size: 16px;
            border-radius: 4px;
        }

        .chat-header {
            background-color: #FF6600;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #000;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }

        .back-button {
            background-color: #666;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background-color: #FFEEEE;
            color: #FF0000;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #117743;
        }

        button {
            background-color: #FF6600;
            border: 1px solid #000;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
            border-radius: 4px;
            font-size: 16px;
        }

        button:hover {
            background-color: #FF8833;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-primary {
            background-color: #117743;
            color: white;
        }

        .btn-secondary {
            background-color: #3366CC;
            color: white;
        }

        .upload-btn {
            background-color: #117743;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .header {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .chats-screen, .chat-screen {
                padding: 12px;
            }
            
            .chat-container, .chats-list {
                max-height: 55vh;
            }
            
            .message-form {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2rem;
            }
            
            input[type="text"], button {
                padding: 12px;
            }
            
            .chat-container, .chats-list {
                max-height: 50vh;
            }
            
            .chat-avatar {
                width: 40px;
                height: 40px;
            }
            
            .chat-item {
                padding: 8px;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ú–æ–∏ –ß–∞—Ç—ã</h1>
            <div class="header-buttons">
                <button onclick="goToHome()" class="btn-secondary">üè† –ö–æ–º–Ω–∞—Ç—ã</button>
                <button onclick="goToProfile()" class="btn-primary">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ -->
        <div id="chatsScreen" class="chats-screen">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤..." oninput="filterChats()">
                <button onclick="searchUsers()">üîç</button>
            </div>

            <div id="chatsList" class="chats-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>
            </div>

            <div id="userSearchResults" class="chats-list hidden"></div>

            <div id="emptyState" class="empty-state hidden">
                <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</h3>
                <p>–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ -->
        <div id="chatScreen" class="chat-screen hidden">
            <div class="chat-header">
                <button onclick="backToChats()" class="back-button">‚Üê –ù–∞–∑–∞–¥</button>
                <span id="currentChatName">–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</span>
                <div id="chatUserInfo"></div>
            </div>
            
            <div id="chatContainer" class="chat-container">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            
            <div class="message-form">
                <input type="text" id="messageInput" class="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500" onkeypress="handleKeyPress(event)">
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="uploadImage()">
                <div style="display: flex; gap: 8px;">
                    <button onclick="sendMessage()" style="flex: 2;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button onclick="document.getElementById('imageInput').click()" class="upload-btn" style="flex: 1;">üì∑ –§–æ—Ç–æ</button>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="error hidden"></div>
    </div>

    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyC-xF1GL7G67XNJOiMUDchcLQRhXANsORk",
            authDomain: "hlypalka.firebaseapp.com",
            projectId: "hlypalka",
            storageBucket: "hlypalka.firebasestorage.app",
            messagingSenderId: "41063525028",
            appId: "1:41063525028:web:253e10e09ec8ff4cf75431",
            measurementId: "G-T5N77WGWYP"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // –ö–ª—é—á API –¥–ª—è imgBB
        const IMGBB_API_KEY = '532c1a46efe25420841b8296f7eeed3f';

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const chatsScreen = document.getElementById('chatsScreen');
        const chatScreen = document.getElementById('chatScreen');
        const chatsList = document.getElementById('chatsList');
        const searchInput = document.getElementById('searchInput');
        const userSearchResults = document.getElementById('userSearchResults');
        const emptyState = document.getElementById('emptyState');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const currentChatName = document.getElementById('currentChatName');
        const chatUserInfo = document.getElementById('chatUserInfo');
        const errorMessage = document.getElementById('errorMessage');

        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let currentUser = null;
        let currentChat = null;
        let currentChatUser = null;
        let unsubscribeChats = null;
        let unsubscribeMessages = null;
        let chats = [];
        let lastUploadedImage = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function init() {
            checkAuthState();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadChats();
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadChats() {
            try {
                unsubscribeChats = db.collection('users').doc(currentUser.uid)
                    .collection('chats')
                    .orderBy('lastMessageTime', 'desc')
                    .onSnapshot(async (snapshot) => {
                        chats = [];
                        chatsList.innerHTML = '';

                        if (snapshot.empty) {
                            emptyState.classList.remove('hidden');
                            return;
                        }

                        emptyState.classList.add('hidden');

                        for (const doc of snapshot.docs) {
                            const chatData = doc.data();
                            const userDoc = await db.collection('users').doc(chatData.userId).get();
                            
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                chats.push({
                                    id: doc.id,
                                    ...chatData,
                                    userData: userData
                                });

                                displayChatItem(doc.id, chatData, userData);
                            }
                        }
                    });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —á–∞—Ç–∞
        function displayChatItem(chatId, chatData, userData) {
            const chatItem = document.createElement('div');
            chatItem.className = `chat-item ${chatData.unreadCount > 0 ? 'unread' : ''}`;
            chatItem.onclick = () => openChat(chatId, userData);

            const time = chatData.lastMessageTime ? 
                formatTime(chatData.lastMessageTime.toDate()) : '';

            chatItem.innerHTML = `
                <img src="${userData.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.username)}&background=FF6600&color=fff&size=50`}" 
                     class="chat-avatar" 
                     alt="${userData.username}">
                <div class="chat-info">
                    <div class="chat-name">${userData.username}</div>
                    <div class="chat-last-message">${chatData.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                </div>
                <div class="chat-meta">
                    <div class="chat-time">${time}</div>
                    ${chatData.unreadCount > 0 ? 
                        `<div class="chat-unread">${chatData.unreadCount}</div>` : 
                        '<div style="width: 20px;"></div>'}
                </div>
            `;

            chatsList.appendChild(chatItem);
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function searchUsers() {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                userSearchResults.classList.add('hidden');
                return;
            }

            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef
                    .where('username', '>=', searchTerm)
                    .where('username', '<=', searchTerm + '\uf8ff')
                    .limit(10)
                    .get();

                userSearchResults.innerHTML = '';
                
                if (snapshot.empty) {
                    userSearchResults.innerHTML = '<div class="chat-item">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                } else {
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        if (user.username !== currentUser.displayName && doc.id !== currentUser.uid) {
                            const userElement = document.createElement('div');
                            userElement.className = 'chat-item';
                            userElement.onclick = () => startChatWithUser(user.username, doc.id);
                            userElement.innerHTML = `
                                <img src="${user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=FF6600&color=fff&size=50`}" 
                                     class="chat-avatar" 
                                     alt="${user.username}">
                                <div class="chat-info">
                                    <div class="chat-name">${user.username}</div>
                                    <div class="chat-last-message">–ù–∞—á–∞—Ç—å —á–∞—Ç</div>
                                </div>
                                <div class="chat-meta">
                                    <button class="btn-small" style="background: #117743; color: white;">üí¨</button>
                                </div>
                            `;
                            userSearchResults.appendChild(userElement);
                        }
                    });
                }
                
                userSearchResults.classList.remove('hidden');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–∞—Ç–æ–≤
        function filterChats() {
            const searchTerm = searchInput.value.toLowerCase();
            const chatItems = chatsList.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const chatName = item.querySelector('.chat-name').textContent.toLowerCase();
                if (chatName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // –ù–∞—á–∞—Ç—å —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        async function startChatWithUser(username, userId) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —á–∞—Ç —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                const existingChat = await db.collection('users').doc(currentUser.uid)
                    .collection('chats').doc(userId)
                    .get();

                if (existingChat.exists) {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
                    const userDoc = await db.collection('users').doc(userId).get();
                    openChat(userId, userDoc.data());
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç
                    const userDoc = await db.collection('users').doc(userId).get();
                    const userData = userDoc.data();

                    const chatData = {
                        userId: userId,
                        username: userData.username,
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        unreadCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('users').doc(currentUser.uid)
                        .collection('chats').doc(userId)
                        .set(chatData);

                    // –°–æ–∑–¥–∞–µ–º —á–∞—Ç –∏ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const currentUserData = {
                        userId: currentUser.uid,
                        username: currentUser.displayName,
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        unreadCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('users').doc(userId)
                        .collection('chats').doc(currentUser.uid)
                        .set(currentUserData);

                    openChat(userId, userData);
                }

                userSearchResults.classList.add('hidden');
                searchInput.value = '';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞');
            }
        }

        // –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
        async function openChat(userId, userData) {
            currentChat = userId;
            currentChatUser = userData;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            currentChatName.textContent = userData.username;
            chatUserInfo.innerHTML = `
                <img src="${userData.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.username)}&background=FF6600&color=fff&size=30`}" 
                     style="width: 30px; height: 30px; border-radius: 50%; margin-left: 10px;"
                     alt="${userData.username}">
            `;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            await db.collection('users').doc(currentUser.uid)
                .collection('chats').doc(userId)
                .update({
                    unreadCount: 0
                });

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
            chatsScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages() {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            const chatId = getChatId(currentUser.uid, currentChat);
            chatContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';

            unsubscribeMessages = db.collection('chats').doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    chatContainer.innerHTML = '';

                    if (snapshot.empty) {
                        chatContainer.innerHTML = '<div class="empty-state"><h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3><p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p></div>';
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        displayMessage(message);
                    });

                    scrollToBottom();
                });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            const timestamp = message.timestamp ? message.timestamp.toDate() : new Date();
            const timeString = formatTime(timestamp);

            let messageContent = message.text || '';
            if (message.imageUrl) {
                messageContent += `<br><img src="${message.imageUrl}" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" loading="lazy">`;
            }

            messageElement.innerHTML = `
                <div class="message-header">
                    <span>${message.username || '–ê–Ω–æ–Ω–∏–º'}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-content">${messageContent}</div>
            `;

            chatContainer.appendChild(messageElement);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && !lastUploadedImage) return;

            const chatId = getChatId(currentUser.uid, currentChat);
            
            const messageData = {
                userId: currentUser.uid,
                username: currentUser.displayName,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (lastUploadedImage) {
                messageData.imageUrl = lastUploadedImage;
                lastUploadedImage = null;
            }

            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                await db.collection('chats').doc(chatId)
                    .collection('messages').add(messageData);

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–∞—Ö –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const lastMessageText = text || 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                
                await db.collection('users').doc(currentUser.uid)
                    .collection('chats').doc(currentChat)
                    .update({
                        lastMessage: lastMessageText,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });

                await db.collection('users').doc(currentChat)
                    .collection('chats').doc(currentUser.uid)
                    .update({
                        lastMessage: lastMessageText,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        unreadCount: firebase.firestore.FieldValue.increment(1)
                    });

                messageInput.value = '';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async function uploadImage() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showError('–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    lastUploadedImage = data.data.url;
                    messageInput.focus();
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    sendMessage();
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getChatId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        function formatTime(date) {
            return date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function backToChats() {
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }

            currentChat = null;
            currentChatUser = null;
            chatScreen.classList.add('hidden');
            chatsScreen.classList.remove('hidden');
            chatContainer.innerHTML = '';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        function goToProfile() {
            window.location.href = 'profil.html';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = init;
    </script>
</body>
</html>